// Order Digit Game

class Player {
  constructor(name, isComputer = false) {
    this.name = name;
    this.isComputer = isComputer;
    this.hiddenNumber = '';
    this.guessHistory = [];
  }

  // Generate a valid 4-digit number for computer
  generateHiddenNumber() {
    if (!this.isComputer) return;
    let digits = [];
    while (digits.length < 4) {
      let d = Math.floor(Math.random() * 10);
      if (digits.length === 0 && d === 0) continue; // no leading 0
      if (!digits.includes(d)) digits.push(d);
    }
    this.hiddenNumber = digits.join('');
  }
}

// Validate input
function isValidNumber(num, allowLeadingZero = false) {
  if (!/^\d{4}$/.test(num)) return false;
  if (!allowLeadingZero && num[0] === '0') return false;
  let digits = new Set(num);
  return digits.size === 4;
}

// Evaluate a guess against the hidden number
function evaluateGuess(hidden, guess) {
  let orders = 0;
  let digits = 0;
  let hiddenArr = hidden.split('');
  let guessArr = guess.split('');

  // Count Orders
  for (let i = 0; i < 4; i++) {
    if (guessArr[i] === hiddenArr[i]) orders++;
  }

  // Count Digits (correct digits in hidden, including Orders)
  for (let d of guessArr) {
    if (hiddenArr.includes(d)) digits++;
  }

  return { orders, digits };
}

// Game Class
class OrderDigitGame {
  constructor(player1Name, player2Name = '', singlePlayer = false) {
    this.players = [
      new Player(player1Name),
      new Player(singlePlayer ? 'Computer' : player2Name, singlePlayer)
    ];
    this.currentTurn = 0;
    this.singlePlayer = singlePlayer;
    this.gameOver = false;
  }

  setHiddenNumbers(p1Number, p2Number = '') {
    if (!isValidNumber(p1Number)) throw 'Player 1 number invalid';
    this.players[0].hiddenNumber = p1Number;

    if (this.singlePlayer) {
      this.players[1].generateHiddenNumber();
    } else {
      if (!isValidNumber(p2Number)) throw 'Player 2 number invalid';
      this.players[1].hiddenNumber = p2Number;
    }
  }

  makeGuess(guess) {
    if (this.gameOver) throw 'Game over';
    let player = this.players[this.currentTurn];
    let opponent = this.players[1 - this.currentTurn];

    if (!isValidNumber(guess, true)) throw 'Invalid guess';

    let result = evaluateGuess(opponent.hiddenNumber, guess);

    // Save guess history
    player.guessHistory.push({
      guess,
      orders: result.orders,
      digits: result.digits
    });

    // Check win
    if (result.orders === 4) {
      this.gameOver = true;
      return { winner: player.name, result };
    }

    // Next turn
    this.currentTurn = 1 - this.currentTurn;

    // If single-player and it's computer's turn, generate auto guess
    if (this.singlePlayer && this.currentTurn === 1 && !this.gameOver) {
      let compGuess = this.generateComputerGuess(opponent);
      return this.makeGuess(compGuess); // recursive call
    }

    return { winner: null, result };
  }

  generateComputerGuess(opponent) {
    // Random valid guess for simplicity
    let guess = '';
    let used = new Set();
    while (guess.length < 4) {
      let d = Math.floor(Math.random() * 10);
      if (guess.length === 0 && d === 0) continue; // no leading 0
      if (!used.has(d)) {
        guess += d;
        used.add(d);
      }
    }
    return guess;
  }

  getGuessHistory() {
    let history = [];
    for (let p of this.players) {
      for (let g of p.guessHistory) {
        history.push({
          player: p.name,
          guess: g.guess,
          orders: g.orders,
          digits: g.digits
        });
      }
    }
    return history;
  }
}

// Example usage
let game = new OrderDigitGame('Alice', '', true); // Single-player
game.setHiddenNumbers('4271'); // Player 1 number

console.log(game.makeGuess('4172')); // Guess Player 2 (computer) hidden
console.log(game.getGuessHistory());
